
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="all" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://blog.davep.org/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
    href="https://blog.davep.org/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
          href="https://blog.davep.org/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light)"
          href="https://blog.davep.org/theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="https://blog.davep.org/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://blog.davep.org/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://blog.davep.org/theme/font-awesome/css/solid.css">

  <link rel="stylesheet" type="text/css" href="https://blog.davep.org/static/davep.css">

  <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">


  <link href="https://blog.davep.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="blog.davep.org Atom">

  <link href="https://blog.davep.org/feed.xml" type="application/rss+xml" rel="alternate" title="blog.davep.org RSS">







 

    <meta name="author" content="Dave Pearson" />
    <meta name="description" content="" />
  <meta property="og:site_name" content="blog.davep.org"/>
  <meta property="og:type" content="blog"/>
  <meta property="og:title" content="blog.davep.org"/>
  <meta property="og:description" content=""/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://blog.davep.org"/>
  <meta property="og:image" content="/static/davep.jpeg">

  <title>blog.davep.org &ndash; Tag Python</title>


</head>
<body >

<aside>
  <div>
    <a href="https://blog.davep.org/">
      <img src="/static/davep.jpeg" alt="davep" title="davep">
    </a>

    <h1>
      <a href="https://blog.davep.org/">davep</a>
    </h1>

    <p>Code, Emacs, VR, Stuff...</p>


    <nav>
      <ul class="list">


            <li>
              <a target="_blank"
                 href="https://blog.davep.org/pages/about.html#about">
                About
              </a>
            </li>
            <li>
              <a target="_blank"
                 href="https://blog.davep.org/pages/dot-files.html#dot-files">
                Dot Files
              </a>
            </li>

          <li>
            <a target="_blank" href="http://davep.at/" >davep@</a>
          </li>
          <li>
            <a target="_blank" href="https://raindrop.io/davep/public-46742255/sort=-created&perpage=30&page=0" >Bookmarks</a>
          </li>
          <li>
            <a target="_blank" href="https://seenbydavep.blogspot.com/" >Photoblog</a>
          </li>
          <li>
            <a target="_blank" href="https://elisp.dev/" >Emacs Packages</a>
          </li>
          <li>
            <a target="_blank" href="https://pypi.org/user/davepearson/" >Python Packages</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="https://github.com/davep"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
      <li>
        <a class="sc-mastodon"
rel="me"           href="https://fosstodon.org/@davep"
           target="_blank">
          <i class="fa-brands fa-mastodon"></i>
        </a>
      </li>
      <li>
        <a class="sc-flickr"
           href="https://www.flickr.com/photos/davepearson/"
           target="_blank">
          <i class="fa-brands fa-flickr"></i>
        </a>
      </li>
      <li>
        <a class="sc-lastfm"
           href="https://www.last.fm/user/davepdotorg"
           target="_blank">
          <i class="fa-brands fa-lastfm"></i>
        </a>
      </li>
      <li>
        <a class="sc-npm"
           href="https://www.npmjs.com/~davep.org"
           target="_blank">
          <i class="fa-brands fa-npm"></i>
        </a>
      </li>
      <li>
        <a class="sc-youtube"
           href="https://www.youtube.com/user/daveporg"
           target="_blank">
          <i class="fa-brands fa-youtube"></i>
        </a>
      </li>
      <li>
        <a class="sc-steam"
           href="https://steamcommunity.com/id/davepdotorg"
           target="_blank">
          <i class="fa-brands fa-steam"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>

<nav>
  <a href="https://blog.davep.org/">Home</a>

  <a href="/archives.html">Archives</a>
  <a href="/categories.html">Categories</a>
  <a href="/tags.html">Tags</a>

  <a href="https://blog.davep.org/feeds/all.atom.xml">Atom</a>

  <a href="https://blog.davep.org/feed.xml">RSS</a>
</nav>



<article>
  <header>
    <h2><a href="https://blog.davep.org/2019/10/19/pypath-el.html#pypath-el">pypath.el -- A little Emacs hack to help with Django</a></h2>
    <p>
      Posted on 2019-10-19 10:35 +0100 in <a href="https://blog.davep.org/category/emacs.html">Emacs</a>

          &#8226; Tagged with
              <a href="https://blog.davep.org/tag/emacs.html">Emacs</a>,              <a href="https://blog.davep.org/tag/python.html">Python</a>,              <a href="https://blog.davep.org/tag/django.html">Django</a>,              <a href="https://blog.davep.org/tag/lisp.html">Lisp</a>
        &#8226; 2 min read
    </p>
  </header>
  <div>
      <div><p>One of the things I really like about coding with Emacs is how I can easily
identify a repeated task and turn it into a command in my environment,
saving me a load of work down the line.</p>
<p><a href="https://github.com/davep/pypath.el"><code>pypath.el</code></a> is one such example.</p>
<p>In my day job I write a lot of Django code. As part of that, I write a good
number of unit tests too. Sometimes I'll write the tests as I'm writing the
code they test, other times I'm writing them afterwards; it all really
depends on where my head's at and how the code is flowing.</p>
<p>When I'm writing those tests, I often want to test them as I go. Given that
starting up a test session can take a while, and given that running all the
tests in the system can take a while, it's really handy if I can run that
single test I'm working on.</p>
<p>This is easy enough with Django. In my work environment it's normally
something like:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>./manage.py<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-v<span class="w"> </span><span class="m">2</span><span class="w"> </span>app.test.some.sub.module.TestClass.test_method
</code></pre></div>

<p>Only... typing out the:</p>
<div class="highlight"><pre><span></span><code><span class="n">app</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">some</span><span class="o">.</span><span class="n">sub</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">TestClass</span><span class="o">.</span><span class="n">test_method</span>
</code></pre></div>

<p>part is a bit of a pain. Sure, once you've typed it the once you can use
your shell of choice (mine being <a href="https://fishshell.com/">fish</a> and on
occasion
<a href="https://www.gnu.org/software/emacs/manual/html_mono/eshell.html">eshell</a>)
to recall it from history, but typing it out the first time is the annoying
part.</p>
<p>So this was the point where I took 1/2 hour or so to code up
<a href="https://github.com/davep/pypath.el"><code>pypath.el</code></a> to solve the problem for
me. It gives me two commands:</p>
<ul>
<li><code>pypath</code>: which simply places the dotted path of the <a href="http://doc.endlessparentheses.com/Fun/python-info-current-defun.html">current
  "defun"</a>,
  within the context of being part of a Django system, into the clipboard
  buffer.</li>
<li><code>pypath-django-test</code>: which works similar to the above but places the
  whole Django testing command into the clipboard.</li>
</ul>
<p>With the above, I can work on a test, hit the latter command above, flip to
my command line, paste and I'm running the test.</p>
<p>Of course, I'm sure there's plenty of other handy ways to do this. Doubtless
there's work environments where the test can be run right there, in the edit
buffer, without flipping away, and which takes into account the fact that
there's a pipenv-managed virtual environment involved, etc. If there is,
that's great, but I don't think it'd work with how I work.</p>
<p>And that's one of the things I really love about Emacs, and why it's still
my work environment after almost 25 years of on and off use: with very
little work on my part I can create a couple of commands that work exactly
how I need them to. While it's great to create <a href="https://melpa.org/">generally-useful code for
Emacs that lots of people benefit from</a>, sometimes the
real value is that <a href="https://blog.davep.org/delpa/">you can code up your own particular quirk and just get
on with stuff</a>.</p>
<p>To conclude: this post isn't to show off <code>pypath.el</code>; really this post is to
sing the praises of Emacs and why it still works so well for me after all
these years.</p></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="https://blog.davep.org/2018/06/02/a_little_speed_issue_with_openpyxl.html#a_little_speed_issue_with_openpyxl">A little speed issue with openpyxl</a></h2>
    <p>
      Posted on 2018-06-02 13:16 +0100 in <a href="https://blog.davep.org/category/python.html">Python</a>

          &#8226; Tagged with
              <a href="https://blog.davep.org/tag/python.html">Python</a>,              <a href="https://blog.davep.org/tag/openpyxl.html">openpyxl</a>
        &#8226; 4 min read
    </p>
  </header>
  <div>
      <div><p>It's been very quiet on the blogging front, I'm afraid, mostly for <a href="/2017/12/12/on_to_something_new.html">the
reasons I wrote about back in December last
year</a>. In that time I've been really
very busy with work (in a good way, in a <em>very</em> good way) and there's not a
whole lot of time to be toying with pet projects at home.</p>
<p>However, finding myself with a spare hour or so, I wanted to write about
something I did run into as part of some development at work, and which I
thought might be worth writing about in case it helps someone else.</p>
<p>Recently I've needed to write a library of code for loading data from Excel
Workbooks. Given that the vast majority of coding I do at the moment is in
Python, it made sense to make use of
<a href="https://openpyxl.readthedocs.io/">openpyxl</a>. The initial prototype code I
wrote worked well and it soon grew into a full-blown library that'll be used
in a couple of work-related projects.</p>
<p>But one thing kept niggling me... It just wasn't as fast as I'd expected.
The workbooks I'm pulling data from aren't that large, and yet it was taking
a noticeable number of seconds to read in the data, and when I let the code
have a go at a directory full of such workbooks... even the fan on the
machine would ramp up.</p>
<p>It didn't seem right.</p>
<p>I did a little bit of profiling and could see that the code was spending
most of its time deep in the guts of some XML-parsing functions. While I
know that an <code>xlsx</code> file is pretty much an XML document, it seemed odd to me
that it would take so much time and effort to pull the data out from it.</p>
<p>Given that I had other code to be writing, and given that the
workbook-parsing code was "good enough" for the moment, I moved on for a
short while.</p>
<p>But, a couple of weeks back, I had a bit of spare time and decided to
revisit it. I did some more searching on openpyxl and speed issues and
almost everything I found said that the common problem was failing to open
the workbook in <code>read_only</code> mode. That can't have been my problem because
I'd being doing that from the very start.</p>
<p>Eventually I came across a post somewhere (sorry, I've lost it for now --
I'll try and track it down again) that suggested that openpyxl was very slow
to read from a workbook if you were reading one cell at a time, rather than
using generators. The suggestion being that every time you pull a value form
a cell, it has to parse the whole sheet up to that cell. Generators, on the
other hand, would allow access to all the cells during one parse.</p>
<p>This seemed a little unlikely to me -- I'd have expected the code to cache
the parsing results or something like that -- but it also would explain what
I was seeing. So I decided to give it a test.</p>
<p><a href="https://github.com/davep/openpyxl-speed-issue"><code>openpyxl-speed-issue</code></a> is a
version of the tests I wrote and ran and they absolutely show that there's a
huge difference between cell-by-cell access vs generator access.</p>
<p>Code like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sheet</span><span class="o">.</span><span class="n">max_row</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">):</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sheet</span><span class="o">.</span><span class="n">max_column</span> <span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">sheet</span><span class="p">[</span> <span class="n">row</span> <span class="p">][</span> <span class="n">col</span> <span class="p">]</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>

<p>is <em>far slower</em> than something like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">wb</span><span class="p">[</span> <span class="s2">&quot;Test Sheet&quot;</span> <span class="p">]</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>

<p>Here's an example of the difference in time, as seen on my iMac:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>make<span class="w"> </span><span class="nb">test</span>
pipenv<span class="w"> </span>run<span class="w"> </span><span class="nb">time</span><span class="w"> </span>./read-using-generators
<span class="w">        </span><span class="m">1</span>.59<span class="w"> </span>real<span class="w">         </span><span class="m">0</span>.44<span class="w"> </span>user<span class="w">         </span><span class="m">0</span>.04<span class="w"> </span>sys
pipenv<span class="w"> </span>run<span class="w"> </span><span class="nb">time</span><span class="w"> </span>./read-using-peeking
<span class="w">       </span><span class="m">25</span>.02<span class="w"> </span>real<span class="w">        </span><span class="m">24</span>.88<span class="w"> </span>user<span class="w">         </span><span class="m">0</span>.10<span class="w"> </span>sys
</code></pre></div>

<p>As you can see, the cell-by-cell approach is about 16 times slower than the
generator approach.</p>
<p>In most circumstances the generator approach would make most sense anyway,
and in any other situation I probably would have used it and never have
noticed this. However, the nature of the workbooks I need to pull data from
means I need to "peek ahead" to make decisions about what I'm doing, so a
more traditional loop over, with an index, made more sense.</p>
<p>I can easily "fix" this by using the generator approach to build up a
two-dimensional array of cells, acquired via the generator; so I can still
do what I want <em>and</em> benefit from using generators.</p>
<p>In conclusion: given that I found it difficult to find information about my
speed issue, and given that the one off-hand comment I saw that suggested it
was this wasn't exactly easy to find, I thought I'd write it all down too
and <a href="https://github.com/davep/openpyxl-speed-issue">create a repository of some test code to illustrate the
issue</a>. Hopefully someone
else will benefit from this in the future.</p></div>
  </div>
</article>

  <div class="pagination">
    <a class="btn float-right" href="https://blog.davep.org/tag/python5.html">
      Newer Posts <i class="fa fa-angle-right"></i>
    </a>
  </div>



<footer>
<p>&copy; 2015-2024 Dave Pearson</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="https://blog.davep.org/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="dark"
          type="text/javascript">
  </script>
</p></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " blog.davep.org ",
  "url" : "https://blog.davep.org",
  "image": "/static/davep.jpeg",
  "description": ""
}
</script>
</body>
</html>